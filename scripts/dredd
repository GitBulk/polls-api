#!/bin/sh

if [ -z "$PORT" ]; then
  PORT=8000
fi

# Configure datbase
export DATABASE=$(pwd)/dredd.sqlite
rm $DATABASE
export DATABASE_URL=sqlite:///$DATABASE

# Sync the database
python manage.py migrate

# Run the dev server
python manage.py runserver $PORT --noreload &
sleep 1
PID=$!

# Seed database with initial poll
curl --data '{"question": "Favourite programming language?", "choices": ["Swift", "Python"]}' http://localhost:$PORT/questions

# Run dredd
dredd apiary.apib http://localhost:$PORT --hookfiles=dredd-hooks.js
RESULT=$?

kill -9 $PID
exit $RESULT

